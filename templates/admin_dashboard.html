{% extends 'base.html' %}
{% block content %}

<div class="admin-nav">
    <button class="tab-link active" onclick="openTab(event, 'Overview')">Overview</button>
    <button class="tab-link" onclick="openTab(event, 'Teachers')">Teachers</button>
    <button class="tab-link" onclick="openTab(event, 'TeacherAssignments')">Teacher Assignments</button>
    <button class="tab-link" onclick="openTab(event, 'Students')">Students</button>
    <button class="tab-link" onclick="openTab(event, 'Parents')">Parents</button>
    <button class="tab-link" onclick="openTab(event, 'Links')">Links</button>
    <button class="tab-link" onclick="openTab(event, 'Subjects')">Subjects</button>
    <button class="tab-link" onclick="openTab(event, 'Auditing')">Auditing</button>
    <button class="tab-link" onclick="openTab(event, 'Settings')">Settings</button>
    <button class="tab-link" onclick="openTab(event, 'Reports')">Reports</button>
    <button class="tab-link" onclick="openTab(event, 'Timetable')">Timetable</button>
    <button class="tab-link" onclick="openTab(event, 'ExamResults')">Exam Results</button>
    <button class="tab-link" onclick="openTab(event, 'ExamTypes')">Exam Types</button>
    <button class="tab-link" onclick="openTab(event, 'PublishResults')">Publish Results</button>
</div>

<div id="Overview" class="tab-content active">
    <div class="card">
        <h3>Overview</h3>
        <div class="grid">
            <div class="card">
                <h4>{{ student_count }}</h4>
                <p>Students</p>
            </div>
            <div class="card">
                <h4>{{ teacher_count }}</h4>
                <p>Teachers</p>
            </div>
            <div class="card">
                <h4>{{ subject_count }}</h4>
                <p>Subjects</p>
            </div>
            <div class="card">
                <h4>{{ audit_count }}</h4>
                <p>Total Audits</p>
            </div>
            <div class="card">
                <h4>{{ pending_count }}</h4>
                <p>Pending Audits</p>
            </div>
        </div>
    </div>
</div>

<div id="Teachers" class="tab-content">
    <div class="card">
        <h3>Teachers Management</h3>
        <form method="post" action="{{ url_for('admin.create_teacher') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <label for="teacher_name">Name</label>
            <input id="teacher_name" name="name" required>
            <label for="teacher_username">Username</label>
            <input id="teacher_username" name="username" required>
            <label for="teacher_email">Email</label>
            <input id="teacher_email" name="email" type="email" required>
            <label for="teacher_class">Class</label>
            <input id="teacher_class" name="class" required>
            <label for="teacher_password">Password</label>
            <input id="teacher_password" name="password" type="password" required>
            <button type="submit">Create Teacher</button>
        </form>
        {% if teachers %}
        <h4>Existing Teachers</h4>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Class</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for t in teachers %}
                <tr>
                    <td>{{ t.name }}</td>
                    <td>{{ t.email }}</td>
                    <td>{{ t.class }}</td>
                    <td>
                        <form method="post" action="{{ url_for('admin.delete_teacher', teacher_id=t.id) }}"
                            style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" class="btn-small btn-secondary">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>

<div id="TeacherAssignments" class="tab-content">
    <div class="card">
        <h3>Assign Subject to Teacher</h3>
        <p>Assign a subject and class to a teacher. Teachers will only be able to allocate subjects they are assigned
            to.</p>
        <form method="post" action="{{ url_for('admin.assign_teacher_subject') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <label for="assign_teacher_id">Teacher</label>
            <select id="assign_teacher_id" name="teacher_id" required>
                <option value="">-- Select Teacher --</option>
                {% for t in teachers %}
                <option value="{{ t.id }}">{{ t.name }}</option>
                {% endfor %}
            </select>
            <label for="assign_subject_id">Subject</label>
            <select id="assign_subject_id" name="subject_id" required>
                <option value="">-- Select Subject --</option>
                {% for s in subjects %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
            </select>
            <label for="assign_class">Class</label>
            <input id="assign_class" name="class" placeholder="e.g. Senior 1" required>
            <button type="submit">Assign Subject to Teacher</button>
        </form>
    </div>

    <div class="card">
        <h3>Current Teacher Assignments</h3>
        {% if teacher_assignments %}
        <table>
            <thead>
                <tr>
                    <th>Teacher</th>
                    <th>Subject</th>
                    <th>Class</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for a in teacher_assignments %}
                <tr>
                    <td>{{ a.teacher_name }}</td>
                    <td>{{ a.subject_name }}</td>
                    <td>{{ a.class }}</td>
                    <td>
                        <form method="post" action="{{ url_for('admin.unassign_teacher_subject', assignment_id=a.id) }}"
                            style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" class="btn-small btn-secondary">Unassign</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="text-align: center; color: #777;">No subject assignments yet. Assign subjects to teachers above.</p>
        {% endif %}
    </div>
</div>

<div id="Students" class="tab-content">
    <div class="card">
        <h3>Students Management</h3>
        <p>Students are registered via teacher dashboard.</p>
        {% if users %}
        <h4>Existing Students</h4>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Class</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>{{ u.name }}</td>
                    <td>{{ u.class }}</td>
                    <td>{{ u.status }}</td>
                    <td>
                        <form method="post" action="{{ url_for('admin.delete_student', user_id=u.id) }}"
                            style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" class="btn-small btn-secondary">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>

<div id="Parents" class="tab-content">
    <div class="card">
        <h3>Parents Management</h3>
        <form method="post" action="{{ url_for('admin.create_parent') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <label for="parent_name">Name</label>
            <input id="parent_name" name="name" required>
            <label for="parent_username">Username</label>
            <input id="parent_username" name="username" required>
            <label for="parent_email">Email</label>
            <input id="parent_email" name="email" type="email" required>
            <label for="parent_phone">Phone</label>
            <input id="parent_phone" name="phone">
            <label for="parent_password">Password</label>
            <input id="parent_password" name="password" type="password" required>
            <button type="submit">Create Parent</button>
        </form>
        {% if parents %}
        <h4>Existing Parents</h4>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                </tr>
            </thead>
            <tbody>
                {% for p in parents %}
                <tr>
                    <td>{{ p.name }}</td>
                    <td>{{ p.email }}</td>
                    <td>{{ p.phone or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>

<div id="Links" class="tab-content">
    <div class="card">
        <h3>Student-Parent Links</h3>
        <form method="post" action="{{ url_for('admin.link_student_parent') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <label for="link_student">Student</label>
            <select id="link_student" name="student_id" required>
                <option value="">-- Select Student --</option>
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.name }}</option>
                {% endfor %}
            </select>
            <label for="link_parent">Parent</label>
            <select id="link_parent" name="parent_id" required>
                <option value="">-- Select Parent --</option>
                {% for p in parents %}
                <option value="{{ p.id }}">{{ p.name }}</option>
                {% endfor %}
            </select>
            <label for="relationship">Relationship</label>
            <input id="relationship" name="relationship" placeholder="e.g. Parent" required>
            <button type="submit">Link</button>
        </form>
        {% if student_parent_links %}
        <h4>Existing Links</h4>
        <table>
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Parent</th>
                    <th>Relationship</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for link in student_parent_links %}
                <tr>
                    <td>{{ link.student_name }}</td>
                    <td>{{ link.parent_name }}</td>
                    <td>{{ link.relationship }}</td>
                    <td>
                        <form method="post" action="{{ url_for('admin.unlink_student_parent', link_id=link.id) }}"
                            style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" class="btn-small btn-secondary">Unlink</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>

    <div class="card" style="margin-top:30px;">
        <h3>Student-Subject Links (Enrollment)</h3>
        <p class="small text-muted">Link a student to a subject. Required before clearance auditing.</p>
        <form method="post" action="{{ url_for('admin.link_subject') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="enroll_student">Student</label>
                    <select id="enroll_student" name="student_id" required>
                        <option value="">-- Select Student --</option>
                        {% for u in users %}
                        <option value="{{ u.id }}">{{ u.name }} ({{ u.class }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label for="enroll_subject">Subject</label>
                    <select id="enroll_subject" name="subject_id" required>
                        <option value="">-- Select Subject --</option>
                        {% for s in subjects %}
                        <option value="{{ s.id }}">{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" style="padding: 10px 20px;">Link Subject</button>
            </div>
        </form>

        {% if student_subject_links %}
        <h4 style="margin-top: 20px;">Existing Enrollment Links</h4>
        <table>
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Subject</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for link in student_subject_links %}
                <tr>
                    <td>{{ link.student_name }}</td>
                    <td>{{ link.subject_name }}</td>
                    <td>
                        <form method="post" action="{{ url_for('admin.unlink_subject') }}"
                            onsubmit="return confirm('Unlink this subject? This will also delete any existing clearance audit.');"
                            style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" name="student_id" value="{{ link.student_id }}">
                            <input type="hidden" name="subject_id" value="{{ link.subject_id }}">
                            <button type="submit" class="btn-small btn-secondary">Unlink</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>

<div id="Subjects" class="tab-content">
    <div class="card">
        <h3>Subject Management</h3>
        <form method="post" action="{{ url_for('admin.manage_subjects') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <label for="subject_name">New Subject</label>
            <input id="subject_name" name="name" placeholder="e.g. Mathematics" required>
            <button type="submit">Add Subject</button>
        </form>
        {% if subjects %}
        <h4>Existing Subjects</h4>
        <ul>
            {% for s in subjects %}
            <li>
                {{ s.name }}
                <form method="post" action="{{ url_for('admin.manage_subjects') }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="subject_id" value="{{ s.id }}">
                    <button type="submit" class="btn-small btn-secondary">Delete</button>
                </form>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
</div>

<div id="Auditing" class="tab-content">
    <div class="card">
        <h3>Assign Subject for Auditing</h3>
        <form method="post" action="{{ url_for('admin.link_subject') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <label for="audit_student_id">Student</label>
            <select id="audit_student_id" name="student_id" required>
                <option value="">-- Select Student --</option>
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.name }} ({{ u.class }})</option>
                {% endfor %}
            </select>
            <label for="audit_subject_id">Subject</label>
            <select id="audit_subject_id" name="subject_id" required>
                <option value="">-- Select Subject --</option>
                {% for s in subjects %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
            </select>
            <button type="submit">Assign Subject</button>
        </form>
    </div>

    <div class="card">
        <h3>Student Auditing Progress</h3>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% if audit_links %}
                    {% for audit in audit_links %}
                    <tr>
                        <td>{{ audit.student_name }}</td>
                        <td>{{ audit.subject_name }}</td>
                        <td>
                            {% if audit.status == 'Cleared' %}
                            <span style="color: green;">✓ Cleared</span>
                            {% elif audit.status == 'Not Cleared' %}
                            <span style="color: red;">✗ Not Cleared</span>
                            {% else %}
                            <span style="color: orange;">⚠ Pending</span>
                            {% endif %}
                        </td>
                        <td>{{ audit.notes or '-' }}</td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center;">No subjects assigned for auditing yet.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="Settings" class="tab-content">
    <div class="card">
        <h3>Email Report Settings</h3>
        <form method="post" action="{{ url_for('admin.save_settings') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

            <label>Send Reports On:</label>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin: 10px 0 20px 0;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" name="send_days" value="0" {% if '0' in send_days %}checked{% endif %}> Mon
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" name="send_days" value="1" {% if '1' in send_days %}checked{% endif %}> Tue
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" name="send_days" value="2" {% if '2' in send_days %}checked{% endif %}> Wed
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" name="send_days" value="3" {% if '3' in send_days %}checked{% endif %}> Thu
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" name="send_days" value="4" {% if '4' in send_days %}checked{% endif %}> Fri
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" name="send_days" value="5" {% if '5' in send_days %}checked{% endif %}> Sat
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" name="send_days" value="6" {% if '6' in send_days %}checked{% endif %}> Sun
                </label>
            </div>

            <label for="send_time">Send Reports At:</label>
            <input type="time" id="send_time" name="send_time" value="{{ send_time }}" style="margin-bottom: 15px;">

            <button type="submit" class="btn">Save Settings</button>
        </form>
    </div>
    <div class="card" style="margin-top: 20px;">
        <h3>Fingerprint Listener</h3>
        <form method="post" action="{{ url_for('admin.toggle_fingerprint_listener') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <p>Status: <strong>{{ 'Enabled' if listener_enabled else 'Disabled' }}</strong></p>
            <button type="submit" class="btn">{{ 'Disable Listener' if listener_enabled else 'Enable Listener'
                }}</button>
        </form>
    </div>
</div>

<div id="Timetable" class="tab-content">
    <div class="card">
        <h3>Manage Timetable</h3>
        <form id="timetable-form" method="post" action="{{ url_for('admin.manage_timetable') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" id="tt_action" name="action" value="add">
            <input type="hidden" id="tt_id" name="timetable_id" value="">

            <label for="tt_class">Class</label>
            <input id="tt_class" name="class" placeholder="e.g. Senior 1" required>

            <label for="tt_subject">Subject</label>
            <select id="tt_subject" name="subject_id" required>
                <option value="">-- Select Subject --</option>
                {% for s in subjects %}
                <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
            </select>

            <label for="tt_teacher">Teacher (Optional)</label>
            <select id="tt_teacher" name="teacher_id">
                <option value="">-- No Teacher Assigned --</option>
                {% for t in teachers %}
                <option value="{{ t.id }}">{{ t.name }}</option>
                {% endfor %}
            </select>

            <label for="tt_day">Day</label>
            <select id="tt_day" name="day_of_week" required>
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
            </select>

            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label for="tt_start">Start Time</label>
                    <input type="time" id="tt_start" name="start_time" required>
                </div>
                <div style="flex: 1;">
                    <label for="tt_end">End Time</label>
                    <input type="time" id="tt_end" name="end_time" required>
                </div>
            </div>

            <button type="submit" id="tt_submit_btn">Add Entry</button>
            <button type="button" id="tt_cancel_btn" style="display: none; background-color: grey;"
                onclick="cancelTTExted()">Cancel Edit</button>
        </form>

        <h4>Existing Timetables</h4>
        {% if timetables %}
        <table>
            <thead>
                <tr>
                    <th>Class</th>
                    <th>Day</th>
                    <th>Time</th>
                    <th>Subject</th>
                    <th>Teacher</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for t in timetables %}
                <tr>
                    <td>{{ t['class'] }}</td>
                    <td>{{ t.day_of_week }}</td>
                    <td>{{ t.start_time }} - {{ t.end_time }}</td>
                    <td>{{ t.subject_name }}</td>
                    <td>{{ t.teacher_name or '-' }}</td>
                    <td>
                        <button type="button" class="btn-small"
                            onclick="editTimetable('{{ t.id }}', '{{ t['class'] }}', '{{ t.subject_id }}', '{{ t.teacher_id or '' }}', '{{ t.day_of_week }}', '{{ t.start_time }}', '{{ t.end_time }}')">
                            Edit
                        </button>
                        <form method="post" action="{{ url_for('admin.manage_timetable') }}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="timetable_id" value="{{ t.id }}">
                            <button type="submit" class="btn-small btn-secondary">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No timetable entries found.</p>
        {% endif %}
    </div>
</div>

<div id="ExamResults" class="tab-content">
    <div class="card">
        <h3>Exam Results Management</h3>
        <form method="post" action="{{ url_for('admin.manage_exam_results') }}" id="exam_result_form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add" id="er_action">
            <input type="hidden" name="result_id" value="" id="er_result_id">

            <div class="grid">
                <div style="flex: 1;">
                    <label for="er_student">Student</label>
                    <select id="er_student" name="student_id" required>
                        <option value="">Select Student</option>
                        {% for st in users %}
                        <option value="{{ st.id }}">{{ st.name }} ({{ st['class'] }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex: 1;">
                    <label for="er_subject">Subject</label>
                    <select id="er_subject" name="subject_id" required>
                        <option value="">Select Subject</option>
                        {% for s in subjects %}
                        <option value="{{ s.id }}">{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="grid">
                <div style="flex: 1;">
                    <label for="er_teacher">Teacher (Optional)</label>
                    <select id="er_teacher" name="teacher_id">
                        <option value="">Select Teacher</option>
                        {% for t in teachers %}
                        <option value="{{ t.id }}">{{ t.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex: 1;">
                    <label for="er_type">Exam Type</label>
                    <input type="text" id="er_type" name="exam_type" placeholder="e.g. Midterm, Final" required>
                </div>
                <div style="flex: 1;">
                    <label for="er_term">Term</label>
                    <input type="text" id="er_term" name="term" placeholder="e.g. Term 1" required>
                </div>
            </div>

            <div class="grid">
                <div style="flex: 1;">
                    <label for="er_score">Score</label>
                    <input type="number" step="0.01" id="er_score" name="score" required>
                </div>
                <div style="flex: 1;">
                    <label for="er_max">Max Score</label>
                    <input type="number" step="0.01" id="er_max" name="max_score" value="100">
                </div>
                <div style="flex: 1;">
                    <label for="er_grade">Grade</label>
                    <input type="text" id="er_grade" name="grade" placeholder="e.g. A">
                </div>
            </div>

            <label for="er_remarks">Remarks</label>
            <textarea id="er_remarks" name="remarks"></textarea>

            <button type="submit" id="er_submit_btn">Add Result</button>
            <button type="button" id="er_cancel_btn" style="display: none; background-color: grey;"
                onclick="cancelEREdit()">Cancel Edit</button>
        </form>

        <h4>Existing Exam Results</h4>
        {% if exam_results %}
        <table>
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Subject</th>
                    <th>Term/Type</th>
                    <th>Score</th>
                    <th>Grade</th>
                    <th>Teacher</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for res in exam_results %}
                <tr>
                    <td>{{ res.student_name }}</td>
                    <td>{{ res.subject_name }}</td>
                    <td>{{ res.term }} - {{ res.exam_type }}</td>
                    <td>{{ res.score }} / {{ res.max_score }}</td>
                    <td>{{ res.grade or '-' }}</td>
                    <td>{{ res.teacher_name or '-' }}</td>
                    <td>
                        <button type="button" class="btn-small" onclick="editExamResult(
                            '{{ res.id }}', 
                            '{{ res.student_id }}', 
                            '{{ res.subject_id }}', 
                            '{{ res.teacher_id or '' }}', 
                            '{{ res.exam_type|escape }}', 
                            '{{ res.term|escape }}', 
                            '{{ res.score }}', 
                            '{{ res.max_score }}', 
                            '{{ res.grade|escape }}', 
                            '{{ res.remarks|escape }}'
                        )">Edit</button>
                        <form method="post" action="{{ url_for('admin.manage_exam_results') }}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="result_id" value="{{ res.id }}">
                            <button type="submit" class="btn-small btn-secondary">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No exam results found.</p>
        {% endif %}
    </div>
</div>

<div id="Reports" class="tab-content">
    <div class="card">
        <h3>Reports</h3>
        <form method="post" action="{{ url_for('admin.send_reports') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <button type="submit">Send Reports</button>
        </form>
    </div>
</div>

<style>
    .admin-nav {
        display: flex;
        overflow-x: auto;
        margin-bottom: 20px;
        border-bottom: 2px solid var(--border-color);
        background-color: var(--off-white);
        padding: 0 10px;
    }

    .tab-link {
        background-color: #f8f9fa;
        border: 1px solid var(--border-color);
        padding: 12px 20px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        border-radius: 5px 5px 0 0;
        margin-right: 5px;
        color: var(--text-dark);
        transition: background-color 0.3s, color 0.3s;
    }

    .tab-link:hover {
        background-color: #e9ecef;
    }

    .tab-link.active {
        background-color: var(--brown-medium);
        color: white;
        border-bottom-color: var(--brown-medium);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var tabcontent = document.getElementsByClassName("tab-content");
        for (var i = 0; i < tabcontent.length; i++) {
            if (!tabcontent[i].classList.contains('active')) {
                tabcontent[i].style.display = "none";
            }
        }
    });

    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    function editTimetable(id, className, subjectId, teacherId, day, start, end) {
        document.getElementById('tt_id').value = id;
        document.getElementById('tt_action').value = 'update';
        document.getElementById('tt_class').value = className;
        document.getElementById('tt_subject').value = subjectId;
        document.getElementById('tt_teacher').value = teacherId;
        document.getElementById('tt_day').value = day;

        // Format TIME (HH:MM:SS) to HH:MM for input[type="time"]
        document.getElementById('tt_start').value = start.substring(0, 5);
        document.getElementById('tt_end').value = end.substring(0, 5);

        document.getElementById('tt_submit_btn').innerText = 'Update Entry';
        document.getElementById('tt_cancel_btn').style.display = 'inline-block';

        // Scroll to form
        document.getElementById('Timetable').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelTTExted() {
        document.getElementById('timetable-form').reset();
        document.getElementById('tt_id').value = '';
        document.getElementById('tt_action').value = 'add';
        document.getElementById('tt_submit_btn').innerText = 'Add Entry';
        document.getElementById('tt_cancel_btn').style.display = 'none';
    }

    function editExamResult(id, studentId, subjectId, teacherId, type, term, score, maxScore, grade, remarks) {
        document.getElementById('er_result_id').value = id;
        document.getElementById('er_action').value = 'update';
        document.getElementById('er_student').value = studentId;
        document.getElementById('er_subject').value = subjectId;
        document.getElementById('er_teacher').value = teacherId;
        document.getElementById('er_type').value = type;
        document.getElementById('er_term').value = term;
        document.getElementById('er_score').value = score;
        document.getElementById('er_max').value = maxScore;
        document.getElementById('er_grade').value = grade;
        document.getElementById('er_remarks').value = remarks;

        document.getElementById('er_submit_btn').innerText = 'Update Result';
        document.getElementById('er_cancel_btn').style.display = 'inline-block';

        document.getElementById('ExamResults').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEREdit() {
        document.getElementById('exam_result_form').reset();
        document.getElementById('er_result_id').value = '';
        document.getElementById('er_action').value = 'add';
        document.getElementById('er_submit_btn').innerText = 'Add Result';
        document.getElementById('er_cancel_btn').style.display = 'none';
    }
</script>

<!-- Exam Types Tab -->
<div id="ExamTypes" class="tab-content">
    <div class="card">
        <h3>Manage Exam Types</h3>
        <p class="small text-muted">Add new exam types or disable old ones.</p>

        <form method="post" action="{{ url_for('admin.manage_exam_types') }}"
            style="margin-bottom: 30px; display: flex; gap: 10px; align-items: flex-end;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="add">

            <div style="flex: 1;">
                <label for="new_exam_type">New Exam Type Name</label>
                <input id="new_exam_type" name="name" placeholder="e.g. Mock, Mid Term" required
                    style="margin-top: 5px;">
            </div>
            <button type="submit" class="btn">Add Type</button>
        </form>

        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for et in exam_types %}
                <tr>
                    <td>{{ et.name }}</td>
                    <td>
                        {% if et.is_active %}
                        <span class="status-present">Active</span>
                        {% else %}
                        <span class="status-absent">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="post" action="{{ url_for('admin.manage_exam_types') }}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="toggle">
                            <input type="hidden" name="type_id" value="{{ et.id }}">
                            <input type="hidden" name="current_status" value="{{ et.is_active }}">
                            {% if et.is_active %}
                            <button type="submit" class="btn btn-small"
                                style="background-color: var(--error-color);">Disable</button>
                            {% else %}
                            <button type="submit" class="btn btn-small"
                                style="background-color: var(--success-color);">Enable</button>
                            {% endif %}
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<!-- Publish Results Tab -->
<div id="PublishResults" class="tab-content">
    <div class="card">
        <h3>Publish Exam Results</h3>
        <p class="small text-muted">Control which exam results are visible to students and parents.</p>

        <table class="table">
            <thead>
                <tr>
                    <th>Term</th>
                    <th>Exam Type</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in exam_publishing_list %}
                <tr>
                    <td>{{ item.term }}</td>
                    <td>{{ item.exam_type }}</td>
                    <td>
                        {% if item.is_published %}
                        <span class="status-present">Published</span>
                        {% else %}
                        <span class="status-absent">Hidden</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="post" action="{{ url_for('admin.manage_publishing') }}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="term" value="{{ item.term }}">
                            <input type="hidden" name="exam_type" value="{{ item.exam_type }}">

                            {% if item.is_published %}
                            <button type="submit" class="btn btn-small"
                                style="background-color: var(--error-color);">Unpublish</button>
                            {% else %}
                            <button type="submit" class="btn btn-small"
                                style="background-color: var(--success-color);">Publish</button>
                            {% endif %}
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" style="text-align: center;">No exam results found to publish.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}